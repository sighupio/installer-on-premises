# Copyright (c) 2022 SIGHUP s.r.l All rights reserved.
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE file.

- name: Kubernetes node preparation
  hosts: master,nodes
  become: true
  roles:
    - kube-node-common
  tags:
    - kube-node-common

- name: Etcd cluster preparation
  hosts: etcd
  become: true
  vars:
    etcd_address: "{{ ansible_host }}"
    etcd_local_pki_dir: ./pki
  roles:
    - etcd
  tags:
    - etcd

- name: Control plane configuration
  hosts: master
  become: true
  vars:
    kubernetes_local_pki_dir: ./pki
  serial: 1
  roles:
    - kube-control-plane
  tags:
    - kube-control-plane

- name: Kubernetes join nodes
  hosts: nodes
  become: true
  vars:
    kubernetes_bootstrap_token: "{{ hostvars[groups.master[0]].kubernetes_bootstrap_token.stdout }}"
    kubernetes_ca_hash: "{{ hostvars[groups.master[0]].kubernetes_ca_hash.stdout }}"
  roles:
    - kube-worker
  tags:
    - kube-worker

