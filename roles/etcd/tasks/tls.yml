---

- name: Making sure the kubeadm-etcd file is on the instance
  ansible.builtin.template:
    src: kubeadm-etcd.yml.j2
    dest: /etc/etcd/kubeadm-etcd.yml

- name: Generating etcd certificates (server, peer, client)
  ansible.builtin.shell: "kubeadm init phase certs {{ item }} --config=/etc/etcd/kubeadm-etcd.yml"
  with_items:
    - etcd-healthcheck-client
    - etcd-peer
    - etcd-server
    - apiserver-etcd-client

- name: Set correct ownership and permissions for etcd certs
  ansible.builtin.file:
    path: "/etc/etcd/pki/etcd/{{ item }}"
    owner: etcd
    group: etcd
    mode: "{{ '0600' if item.endswith('.key') else '0644' }}"
  loop:
    - peer.crt
    - peer.key
    - server.crt
    - server.key
    - healthcheck-client.crt
    - healthcheck-client.key
